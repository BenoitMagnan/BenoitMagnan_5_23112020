<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!--LIEN VERS LA POLICE DE CHARACTERES RALEWAY-->
  <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
  <!---->

  <!--LIEN DE CONNEXION VERS FONTAWESOME-->
  <link rel="preconnect" href="https://fonts.gstatic.com"> 
  <script src="https://kit.fontawesome.com/637b694283.js" crossorigin="anonymous"></script>
  <script src="../javascript/javascript.js"></script>
  <!---->
  

  <link rel="stylesheet" href="../css/style.css" />
  
  <title>Orinoco - Vente en ligne</title>
</head>

<body>

  <div class="bg-primary">
    <div class="container">
      <div class="row">
        <nav class="col navbar navbar-light">
          <a class="navbar-brand" href="../index.html"><img class="mr-4" src="../logo.png"  alt="Logo d'Orinoco - Retour à la page d'acceuil" /></a>
            <ul class="navbar-nav">
              <li class="nav-item ">
                <a class="nav-link" href="panier.html"><i class="fas fa-shopping-basket"></i></a>
              </li>
            </ul>
        </nav>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="flex-row py-2 my-4 bg-primary rounded text-center">
        <div class="col-12">
          <table class="table my-4">
            <thead>
              <h3 class="my-4">Panier</h3>
              <p id="empty"></p>
            </thead>
            <tbody id="productHolder">
              <!-- <theader>
                <th>Produit</th>
                <th>Photo</th>
                <th>Modèle</th>
                <th>Prix</th>
                <th>Retirer</th>
              </theader> -->
            </tbody>
          </table>
        </div>
    </div>
  </div>

  <div id="dismissTotal" class="container my-4">
    <div class="flex-row py-2 my-4 bg-primary rounded text-center">
        <div>
          <p class="col-6 my-auto ml-auto">Total : <span id="totalPanier"></span> €</p>
        </div>
    </div>

      <form class="my-4 pb-5">

        <div class="my-4">
          <h2>Passer votre commande</h2>
          <em>Veuillez renseigner vos informations personnelles dans le formulaire suivant.</em>
        </div>

        <div class="form-row ">

          <div class="form-group col-6">
            <input type="text" class="form-control" id="firstName" placeholder="Benoît" value="Benoît"  pattern="[A-zÀ-ÿ'\s-]{2,50}" maxlength="50" required>
          </div>
          <div class="form-group col-6">
            <input type="text" class="form-control" id="lastName" placeholder="Magnan"  value="Magnan" pattern="[A-zÀ-ÿ'\s-]{2,50}" maxlength="50" required>
          </div>
          
        </div>

        <div class="form-group">
          <input type="email" class="form-control" id="email" placeholder="benoit.magnan@coderavecdesmoufles.com" value="benoit.magnan@coderavecdesmoufles.com" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$" required>
        </div>

        <div class="form-group">
          <input type="text" class="form-control" id="adress" placeholder="112 rue des Moufles" value="112 rue des Moufles" pattern="[0-9]{1,6}[A-zÀ-ÿ'\s-]{2,50}" maxlength="200" required>
        </div>

        <div class="form-row">
          <div class="form-group col-sm-10 col-8">
            <input type="text" class="form-control" id="city" placeholder="Bar-le-duc" value="Bar-le-duc" pattern="[A-zÀ-ÿ'\s-]{2,50}" maxlength="200" required>
          </div>
          <div class="form-group col-sm-2 col-4">
            <input type="text" class="form-control" id="codePostal" placeholder="5 chiffres" value="91540" pattern="[0-9]{5}" minlength="5" maxlength="5" required>
          </div>
        </div>
        
        <button type="submit" id="Submit" class="submit float-right">Commander</button>
      </form>

      <div id="result"></div>

  </div>

  <script>
    //RETIRE LA LIGNE HTML CONTENANT LES INFOS DE L'OBJET
    function removeItem(element) {
      const itemToRemove = element.parentElement.parentElement;
      itemToRemove.remove(1);
    }
    
    //AFFICHE LA LIGNE PANIER VIDE SI LE LOCALSTORAGE EST VIDE
    if (localStorage.length < 1 ){
      empty.innerHTML = "Votre panier est vide";
      productHolder.innerHTML = "";
      dismissTotal.innerHTML = "";
    } else {
      
      //REMPLISSAGE DU PANIER LIGNE PAR LIGNE AU CHARGEMENT DE LA PAGE
      window.addEventListener('load', () => {

        const items = JSON.parse(localStorage.getItem('items'));
        

        productHolder.innerHTML = "<theader>"
                // + "<th>Produit</th>"
                + "<th>Modèle</th>"
                + "<th>Produit</th>"
                + "<th>Prix</th>"
                + "<th>Retirer</th>"
              + "</theader>"

        items.forEach(element => {
          let newID = element.choice.replace(/\s/g, '');
          
          productHolder.innerHTML += "<tr id='" + element + "'>"
            // + "<td class='align-middle col-2'>" + element.name + "</td>"
            + "<td class='align-middle col-2" + newID + "'>" + element.choice + "</td>"
            + "<td class='align-middle col-4'>" + "<img class='mw-100 rounded shadow'src='" + element.imageUrl + "'></td>"
            + "<td class='align-middle col-3'><span class='price'>" + element.price / 100 + "</span>€</td>"
            + "<td class='align-middle col-3'><button class='removeItem ' onclick='removeItem(this);'><i class='fas fa-trash'></i></button></td>"
          + "</tr>"
          ;
          
          //CALCUL DU TOTAL DU PANIER
          const price = document.getElementsByClassName('price');
          const totalPanier = document.getElementById('totalPanier');

          sum = 0;
          for(i = 0; i < price.length; i++){
            sum += parseInt(price[i].innerHTML);
            totalPanier.innerHTML = sum;
          }
          
          //RETIRER UN ELEMENT DU PANIER + UPDATE DU TOTAL DU PANIER
          const removeItem = document.getElementsByClassName('removeItem');

          for (i = 0; i < removeItem.length; i++) {
            
            removeItem[i].addEventListener("click", function() {
            
              //MISE A JOUR DU TOTAL
              sum = 0;
              for(i = 0; i < price.length; i++){
                sum += parseInt(price[i].innerHTML);
                totalPanier.innerHTML = sum;
              }

              //RETRAIT DE L'OBJET DANS LE LOCALSTORAGE
              let items = JSON.parse(localStorage.getItem('items'));
              items.splice(items.indexOf(items[i]), 1);
              localStorage.setItem('items', JSON.stringify(items));
                
              //AFFICHAGE DU "PANIER VIDE" S'IL N'Y A PLUS D'ELEMENT DANS LE LOCALSTORAGE
              if (items.length < 1) {
                empty.innerHTML = "Votre panier est vide";
                productHolder.innerHTML = "";
                dismissTotal.innerHTML = "";
              }
            });
          };          
        });

        document.getElementById("Submit").addEventListener('click', addContact);

        function addContact (event) {
          event.preventDefault();
          let contact = {
            firstName : document.getElementById('firstName').value,
            lastName : document.getElementById('lastName').value,
            adress : document.getElementById('adress').value,
            city : document.getElementById('codePostal').value + " " + document.getElementById('city').value,
            email : document.getElementById('email').value,
            products : items,
            totalPanier : totalPanier.innerHTML,
            orderId : Date.now() + "-" + Math.floor(Math.random() * 100000) + "-" + document.getElementById('lastName').value
          }
          console.log(contact);
          fetch("https://mockbin.com/request", { //adresse de test de requête 
            method: "POST",
            headers: {
              'Accept': 'application/json', 
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(contact)
          })
          .then(function(resultat) {
            if (resultat.ok) {
              return resultat.json();
            }
          }).then(function(value) {
              localStorage.clear();
              localStorage.setItem("commande", value.postData.text);
              console.log(localStorage);
              window.location.href="commande.html";
            });
          }

      });
    }
  </script>

</body>
</html>